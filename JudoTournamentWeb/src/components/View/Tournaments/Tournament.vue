<template>
  <div class="judo-tournament">
    <!-- ФИЛЬТРЫ -->
    <div class="judo-tournament-setting_search">
      <select class="judo-tournament-setting_search_select_category" name="tournament_filter_category">
        <option value="all">Категория турнира</option>
        <option value="continental">Континентальные</option>
        <option value="national">Национальные</option>
        <option value="regional">Региональные</option>
      </select>
      <select class="judo-tournament-setting_select_age_group" name="tournament_age_group">
        <option value="all">Возрастная группа</option>
        <option value="cadets">Кадеты (15-17 лет)</option>
        <option value="juniors">Юниоры (18-20 лет)</option>
        <option value="seniors">Взрослые (21+ лет)</option>
      </select>
      <select class="judo-tournament-setting_date" name="tournament_date">
        <option value="all">Год проведения</option>
        <option value="2025">2025</option>
        <option value="2024">2024</option>
        <option value="2023">2023</option>
      </select>
      <input type="search" name="tournament_search" placeholder="Поиск турниров" class="search-input" />
    </div>

    <!-- СПИСОК ТУРНИРОВ -->
    <div class="judo-tournament_info">
      <section class="judo-tournament-list">
        <h2>Ближайшие турниры</h2>

        <!-- Индикатор загрузки -->
        <div v-if="isLoading" class="loading-indicator">
          <div class="loading-spinner"></div>
          <p>Загрузка турниров...</p>
        </div>

        <!-- Сообщение об ошибке -->
        <div v-else-if="error" class="error-message">
          <p>{{ error }}</p>
          <button @click="loadTournaments" class="retry-button">Попробовать снова</button>
        </div>

        <!-- Список турниров -->
        <div v-else class="tournament-cards-container">
          <article
              v-for="tournament in tournaments"
              :key="tournament.id"
              class="judo-tournament-card"
              :class="{
              'featured': isFeatured(tournament),
              'live': tournament.status === 'LIVE'
            }"
              @click="navigateToDetails(tournament.id)"
          >
            <div v-if="isFeatured(tournament)" class="featured-badge">Главный турнир</div>
            <div class="judo-tournament_card_info">
              <div class="tournament-header">
                <span class="tournament-date-badge">{{ formatDate(tournament.start_date, tournament.end_date) }}</span>
                <span class="tournament-status-badge" :class="getStatusClass(tournament.status)">
                  {{ getStatusText(tournament.status) }}
                </span>
              </div>
              <h3 class="judo-tournament_card_name">{{ tournament.name }}</h3>
              <p class="judo-tournament_card_location">{{ getLocation(tournament) }}</p>
              <div class="tournament-stats">
                <span class="stat-item">{{ tournament.athletes_count || 0 }} участников</span>
                <span class="stat-divider">•</span>
                <span class="stat-item">{{ tournament.progress_percentage || 0 }}% завершено</span>
              </div>
              <div v-if="tournament.description" class="tournament-description">
                {{ tournament.description }}
              </div>
            </div>
          </article>

          <!-- Сообщение если нет турниров -->
          <div v-if="tournaments.length === 0 && !isLoading" class="no-tournaments">
            <p>Нет доступных турниров</p>
          </div>
        </div>
      </section>
    </div>

    <!-- ПАГИНАЦИЯ -->
    <div v-if="tournaments.length > 0" class="judo-tournament_button_pagination">
      <button type="button" class="judo-tournament_button_pagination_next" @click="loadMore">
        Показать ещё турниры
      </button>
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue'
import { useRouter } from 'vue-router'
import { fetchTournaments } from '@/components/View/Tournaments/fetchTournaments.js'
import "./Tournaments.css"

const router = useRouter()

// Состояния
const tournaments = ref([])
const isLoading = ref(false)
const error = ref('')

// Загрузка турниров через импортированную функцию
const loadTournaments = async () => {
  isLoading.value = true
  error.value = ''

  try {
    const result = await fetchTournaments()

    if (result.success) {
      tournaments.value = result.data
    } else {
      error.value = result.error
      // Мок данные для демонстрации
      tournaments.value = getMockTournaments()
    }
  } catch (err) {
    console.error('Ошибка при загрузке турниров:', err)
    error.value = 'Не удалось загрузить турниры. Пожалуйста, попробуйте позже.'
    tournaments.value = getMockTournaments()
  } finally {
    isLoading.value = false
  }
}

// Мок данные
const getMockTournaments = () => {
  return [
    {
      "athletes_count": 125,
      "city": "Астана",
      "country": "Казахстан",
      "description": "Чемпионат Казахстана среди кадетов 2025 года",
      "end_date": "2025-03-19",
      "id": 1,
      "name": "Чемпионат Казахстана среди кадетов",
      "progress_percentage": 0,
      "start_date": "2025-03-17",
      "status": "PLANNED",
      "tatami_count": 3,
      "venue": "Дворец спорта"
    },
    {
      "athletes_count": 240,
      "city": "Астана",
      "country": "Казахстан",
      "description": "Главный турнир сезона 2025",
      "end_date": "2025-05-12",
      "id": 2,
      "name": "Гран-при Казахстана 2025",
      "progress_percentage": 45,
      "start_date": "2025-05-10",
      "status": "LIVE",
      "tatami_count": 5,
      "venue": "Спорткомплекс 'Алатау'"
    },
    {
      "athletes_count": 180,
      "city": "Астана",
      "country": "Казахстан",
      "description": "Ежегодный кубок города Астаны",
      "end_date": "2024-11-17",
      "id": 3,
      "name": "Кубок Астаны 2024",
      "progress_percentage": 100,
      "start_date": "2024-11-15",
      "status": "COMPLETED",
      "tatami_count": 2,
      "venue": "Спортзал 'Жастар'"
    }
  ]
}

// Вспомогательные функции
const formatDate = (startDate, endDate) => {
  if (!startDate) return ''

  const start = new Date(startDate)
  const end = new Date(endDate)

  if (startDate === endDate) {
    return start.toLocaleDateString('ru-RU')
  }

  return `${start.toLocaleDateString('ru-RU')} – ${end.toLocaleDateString('ru-RU')}`
}

const getLocation = (tournament) => {
  const parts = []
  if (tournament.venue) parts.push(tournament.venue)
  if (tournament.city) parts.push(tournament.city)
  if (tournament.country && tournament.country !== 'string') parts.push(tournament.country)

  return parts.join(', ') || 'Место не указано'
}

const getStatusClass = (status) => {
  const statusMap = {
    'LIVE': 'status-live',
    'PLANNED': 'status-planned',
    'COMPLETED': 'status-completed',
    'REGISTRATION': 'status-registration',
    'WEIGHING': 'status-weighing',
    'BRACKETS': 'status-brackets'
  }
  return statusMap[status] || 'status-planned'
}

const getStatusText = (status) => {
  const statusMap = {
    'LIVE': 'LIVE',
    'PLANNED': 'PLANNED',
    'COMPLETED': 'COMPLETED',
    'REGISTRATION': 'РЕГИСТРАЦИЯ',
    'WEIGHING': 'ВЗВЕШИВАНИЕ',
    'BRACKETS': 'СЕТКИ'
  }
  return statusMap[status] || status
}

const isFeatured = (tournament) => {
  return tournament.status === 'LIVE' || tournament.id === 2
}

const loadMore = () => {
  console.log('Загрузка дополнительных турниров...')
}

// ИСПРАВЛЕННАЯ ФУНКЦИЯ ПЕРЕХОДА
const navigateToDetails = (id) => {
  console.log('Переход к турниру с ID:', id)
  router.push(`/tournamentdetails/${id}`)
}

// Загрузка данных при монтировании
onMounted(() => {
  loadTournaments()
})
</script>

<style scoped>
.judo-tournament-card {
  cursor: pointer;
}

.judo-tournament-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}
</style>